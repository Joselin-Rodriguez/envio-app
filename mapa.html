<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>App de Env√≠os</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #map { height: 400px; margin-top: 20px; }
    form { margin-bottom: 20px; background-color: #f5f5f5; padding: 10px; border-radius: 6px; }
  </style>
</head>
<body>
  <h2>üì¶ Solicitar Env√≠o</h2>

  <form id="formSolicitud">
    <label>ID del Cliente:</label><br />
    <input type="text" id="clienteId" required /><br /><br />

    <label>Art√≠culo a enviar:</label><br />
    <input type="text" id="articulo" required /><br /><br />

    <button type="submit">Enviar solicitud</button>
  </form>

  <h3>üó∫Ô∏è Mapa de pedidos activos</h3>
  <div id="map"></div>

  <script>
    const map = L.map('map').setView([9.838, -83.905], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Solicitar env√≠o
    document.getElementById('formSolicitud').addEventListener('submit', async e => {
      e.preventDefault();
      const clienteId = document.getElementById('clienteId').value;
      const articulo = document.getElementById('articulo').value;

      navigator.geolocation.getCurrentPosition(async pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        await fetch('/solicitud-envio', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ clienteId, lat, lng, articulo })
        });

        alert('‚úÖ Solicitud enviada con √©xito');
        document.getElementById('formSolicitud').reset();
      });
    });

    // Mostrar solicitudes en el mapa
    async function mostrarSolicitudes() {
      const res = await fetch('/solicitudes');
      const data = await res.json();

      map.eachLayer(layer => {
        if (layer instanceof L.Marker) map.removeLayer(layer);
      });

      data.forEach(s => {
        const marker = L.marker([s.lat, s.lng], {
          icon: L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/565/565547.png',
            iconSize: [30, 30],
            iconAnchor: [15, 30]
          })
        }).addTo(map);

        marker.bindPopup(`üì¶ ${s.articulo}<br>üë§ Cliente: ${s.clienteId}`);
      });
    }

    // Calcular distancia entre dos puntos
    function distanciaKm(lat1, lng1, lat2, lng2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLng/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Notificaciones cuando el repartidor se acerque
    async function verificarProximidad() {
      if (Notification.permission !== 'granted') {
        await Notification.requestPermission();
      }

      const res = await fetch('/solicitudes');
      const envios = await res.json();

      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        envios.forEach(envio => {
          const d = distanciaKm(lat, lng, envio.lat, envio.lng);
          if (d < 0.2) {
            new Notification(`üìç Cerca de cliente ${envio.clienteId}`, {
              body: `Entrega: ${envio.articulo}`,
              icon: 'https://cdn-icons-png.flaticon.com/512/565/565547.png'
            });
          }
        });
      });
    }

    // Actualizaci√≥n peri√≥dica
    setInterval(mostrarSolicitudes, 5000);
    setInterval(verificarProximidad, 10000);
  </script>
</body>
</html>